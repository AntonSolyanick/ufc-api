name: UFC Parser
on:
    schedule:
        - cron: '0 23 * * *' # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 –ø–æ –ú–°–ö
    push:
        branches:
            - main # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ push –≤ main
    workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

jobs:
    run-parser:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install Chromium
              run: |
                  sudo apt-get update
                  sudo apt-get install -y chromium
                  echo "CHROME_PATH=/usr/bin/chromium" >> $GITHUB_ENV

            - name: Verify project structure
              run: |
                  echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/utils:"
                  ls -la src/utils/
                  echo "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞ –ø–∞—Ä—Å–µ—Ä–∞:"
                  find . -name "parsersUfC.ts"

            - name: Run Parser with Retry
              env:
                  DATABASE: ${{ secrets.DATABASE }}
              run: |
                  npm install
                  MAX_RETRIES=5  # –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
                  ATTEMPT=1
                  SUCCESS=false

                  while [ $ATTEMPT -le $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
                      echo "–ü–æ–ø—ã—Ç–∫–∞ $ATTEMPT –∏–∑ $MAX_RETRIES..."
                      if npx ts-node src/utils/parsersUFC.ts; then
                          echo "‚úÖ –ü–∞—Ä—Å–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
                          SUCCESS=true
                      else
                          echo "‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ø—ã—Ç–∫–µ $ATTEMPT. –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º..."
                          sleep 10
                          ((ATTEMPT++))
                      fi
                  done

                  if [ "$SUCCESS" = false ]; then
                      echo "üö® –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –æ—à–∏–±–∫–æ–π!"
                      exit 1
                  fi
